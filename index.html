<!DOCTYPE html>
<html>

<head>

    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="vue.js"></script>
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="w3.css" />
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>
    <script src="turf.min.js"></script>
    <link rel="stylesheet" href="leaflet.pm.css" />
    <script src="leaflet.pm.min.js"></script>
</head>
<body>
    <div class="container">
        <p>Tambahkan poligon untuk melihat hasil</p>
        <div id="mapid" style="width: 1000px; height: 500px;"></div>
        <hr/>
        <label>Hasil GeoJSON</label>
        <textarea id="hasil" class="w3-input w3-border"></textarea>
    </div>
    <script>
    var posisi = [-7.8312189550359586, 110.2565517439507];
    var zoom = 13;
    var token = 'pk.eyJ1IjoiZWdvZGFzYSIsImEiOiJjamd4NWkyMmwwNms2MnhsamJvaWQ3NGZmIn0.6ok1IiPZ0sPNXmiIe-iEWA';
    var mymap = null;
    var options = {
        position: 'topleft', // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
        drawMarker: false, // adds button to draw markers
        drawPolyline: false, // adds button to draw a polyline
        drawRectangle: true, // adds button to draw a rectangle
        drawPolygon: true, // adds button to draw a polygon
        drawCircle: false, // adds button to draw a cricle
        cutPolygon: false, // adds button to cut a hole in a polygon
        editMode: false, // adds button to toggle edit mode for all layers
        removalMode: false, // adds a button to remove layers
    };
    var point1 = null;
    var geojsonFeature = null;
    var polygonStyle = {
            fillColor: '#800026',
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: '3',
            fillOpacity: 0.7
        };
    var listPolygon = [];
    var listGeoJson = [];
    var geoJSON = null;
    
    //Setiap layer baru, di masukkan ke variabel ini agar bisa dihapus jika batal membuat polygon
    var currentLayerJSON = null;
    // EOF DATA
    
    //START OF METHOD
    function el(x){
        return document.getElementById(x);
    }
    function showHasil(){
        if(listGeoJson) el("hasil").value = JSON.stringify(listGeoJson);
        else el("hasil").value = null;
    }
    function initMap(){
        mymap = L.map('mapid').setView(posisi, zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            id: 'mapid'
            }).addTo(mymap);
        mymap.pm.addControls(options);
        mymap.on('pm:create', function(e){
            //layer dimasukkan ke variabel agar bisa dihapus
            currentLayerJSON = e;
            
            //Menampilkan popup untuk layer baru
            e.layer.bindPopup(getPopUp(e.layer._latlngs), {className: "w3-panel"}).openPopup();
        });
        refreshMap();
    };
    function refreshMap(){
        if(currentLayerJSON) {
            currentLayerJSON.layer.remove();
        }
        if(geoJSON){
            geoJSON.clearLayers();
        }
        this.mymap.closePopup();
        if(listPolygon.length != 0){
            listGeoJson = [];
            for(var x = 0; x < listPolygon.length; x++){
                listGeoJson.push(turf.polygon([listPolygon[x].marker], listPolygon[x].prop));
            }
            geojsonFeature = turf.featureCollection(listGeoJson);
            geoJSON = L.geoJSON(geojsonFeature, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(feature.properties.pesan + "<button class='w3-btn w3-red'>Hapus</button>");
                },
                style: function(feature){
                    return feature.properties.style
                }
            }).addTo(mymap);
            mymap.fitBounds(geoJSON.getBounds());
        }
        showHasil();
    };
    function addPolygon(x){
        var y = [];
        for(var z = 0; z < x[0].length; z++){
            y.push([x[0][z].lng, x[0][z].lat])
        }
        y.push(y[0]);
        listPolygon.push({marker: y,prop: {
                    pesan: el("pesan").value,
                    style: {
                        fillColor: el("fillColor").value,
                        weight: el("weight").value,
                        opacity: 1,
                        color: el("color").value,
                        dashArray: el("dashArray").value,
                        fillOpacity: el("fillOpacity").value
                    }
                }});
        refreshMap();
    };
    function getPopUp(x){
        x = JSON.stringify(x)
        return "<div style='width:150px;'><p><label>Warna Isian</label> <input class='w3-input w3-border' type='color' id='fillColor' /></p>" +
            "<p><label>Warna Pembatas</label> <input class='w3-input w3-border' type='color' id='color' /></p>" +
            "<p><label>Besar Strip Pembatas</label> <input class='w3-input w3-border' type='number' id='dashArray' /></p>" +
            "<p><label>Ketebalan Pembatas</label> <input class='w3-input w3-border' type='number' id='weight' /></p>" +
            "<p><label>Besar Transparant</label> <input class='w3-input w3-border' type='number' id='fillOpacity' step='0.1' /></p>" +
            "<p><label>Isi Pesan</label> <textarea class='w3-input w3-border' id='pesan'></textarea></p>" +
            "<button type='button' class='w3-btn w3-teal' onclick='addPolygon("+x+");'>Terapkan</button>" +
            "<button type='button' class='w3-btn w3-red' onclick='currentLayerJSON.layer.remove(); refreshMap();'>Batal</button></div>";
    };
    //EOF METHOD
    
    //START OF PROGRAM
    initMap();
    
    </script>
</body>

</html>
