<!DOCTYPE html>
<html>

<head>

    <title>GIS with LeafletJS</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="w3.css" />
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>
    <script src="turf.min.js"></script>
    <link rel="stylesheet" href="leaflet.pm.css" />
    <script src="leaflet.pm.min.js"></script>
</head>
<body>
    <div class="w3-container w3-teal">
        <h1>Contoh Penggunaan LeafletJS + OpenStreetMap + TurfJS</h1>
    </div>
    <div class="w3-container">
        <h4>Pilih Penyedia peta</h4>
        <select class="w3-select" style="width:75%;" onChange="gantiPeta(this.options[this.selectedIndex].value)">
            <option value="OpenStreetMap" selected>OpenStreetMap</option>
            <option value="Mapbox Streets">Mapbox Streets</option>
            <option value="Mapbox Satellite">Mapbox Satellite</option>
        </select>
        <div class="w3-row">
            <div class="w3-col l6 m12 s12 xs12">
                <h3>Tambahkan poligon untuk melihat hasil</h3>
                <div id="mapid" style="width: 500px; height: 500px;"></div>
            </div>
            <div class="w3-col l6 m12 s12 xs12">
                <h3>Daftar Polygon</h3>
                <table id="listMarker" class="w3-table w3-border w3-striped w3-hover"></table>
            </div>
            <div class="w3-col l6 m12 s12 xs12">
                <h3>Hasil GeoJSON</h3>
                <textarea class="w3-input w3-border" id="hasilGeoJSON"></textarea>
                <button class="w3-button w3-blue-gray" onclick="importGeoJSON()">Import GeoJSON</button>
            </div>
        </div>
    </div>
    <div class="w3-container w3-margin-top w3-blue-grey">
        <h3>Source: <a href="https://github.com/egodasa/gisleafletosm">github.com/egodasa/gisleafletosm</a></h3>
    </div>
    <script>
    //START OF DATA
    var posisi = [-0.942942, 100.371857];
    var zoom = 13;
    var token = 'pk.eyJ1IjoiZWdvZGFzYSIsImEiOiJjamd4NWkyMmwwNms2MnhsamJvaWQ3NGZmIn0.6ok1IiPZ0sPNXmiIe-iEWA';
    var mymap = null;
    var options = {
        position: 'topleft', // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
        drawMarker: false, // adds button to draw markers
        drawPolyline: false, // adds button to draw a polyline
        drawRectangle: true, // adds button to draw a rectangle
        drawPolygon: true, // adds button to draw a polygon
        drawCircle: false, // adds button to draw a cricle
        cutPolygon: false, // adds button to cut a hole in a polygon
        editMode: false, // adds button to toggle edit mode for all layers
        removalMode: false, // adds a button to remove layers
    };
    var defaultStyle = {
            fillColor: '#800026',
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: '3',
            fillOpacity: 0.7
        };
    var listMarker = [];
    var geoJSON = null;
    var exportGeoJSON = null;
    
    //Setiap layer baru, di masukkan ke variabel ini agar bisa dihapus jika batal membuat polygon
    var currentLayerJSON = null;
    var currentId = null;
    
    //Defenisi tabel poligon
    var tableHead = [
    {
        name: "_no",
        caption: "No",
        format: function(x){ 
            return x+1;
            }
    },
    {
        name: "prop",
        caption: "Isi Pesan",
        format: function(x){ 
            return x.message;
            }
    },
    {
        name: "prop",
        caption: "Warna Poligon",
        format: function(x){ 
            return "<div style='width: 100px; height: 25px; background-color: " + x.style.fillColor + "; border: 5px dashed " + x.style.color +";'></div>";
            }
    },
    {
        name: "_aksi",
        caption: "Aksi",
        format: function(x){ 
            return "<button type='button' class='w3-btn w3-red' onclick='deletePolygon(" + x + ")'>Hapus</button>";
            }
    }];
    // EOF DATA
    
    //START OF METHOD
    function el(x){
        return document.getElementById(x);
    }
    function showHasilGeoJSON(){
        if(geoJSON) el("hasilGeoJSON").value = JSON.stringify(geoJSON.toGeoJSON());
        else el("hasilGeoJSON").value = null;
    }
    function initMap(peta = 'OpenStreetMap'){
        //Token mapbox : pk.eyJ1IjoiZWdvZGFzYSIsImEiOiJjamd4NWkyMmwwNms2MnhsamJvaWQ3NGZmIn0.6ok1IiPZ0sPNXmiIe-iEWA
        mymap = L.map('mapid').setView(posisi, zoom);
        switch(peta){
            case 'Mapbox Streets' : 
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+token, {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                    id: 'mapbox.streets'
                }).addTo(mymap);
            break;
            case 'Mapbox Satellite' : 
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token='+token, {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                    id: 'mapbox.satellite'
                }).addTo(mymap);
            break;
            case 'OpenStreetMap' :
            default : 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
                    id: 'mapid'
                }).addTo(mymap);
        }
        
        mymap.pm.addControls(options);
        mymap.on('pm:create', function(e){
            //layer dimasukkan ke variabel agar bisa dihapus
            currentLayerJSON = e;
            
            //Menampilkan popup untuk layer baru
            e.layer.bindPopup(getPopUp(e.layer._latlngs), {className: "w3-panel"}).openPopup();
        });
    };
    function refreshMap(){
        if(currentLayerJSON) {
            currentLayerJSON.layer.remove();
        }
        if(geoJSON){
            geoJSON.clearLayers();
        }
        this.mymap.closePopup();
        el("listMarker").innerHTML = showTable(tableHead, listMarker);
        showGeoJSON();
    }
    function showGeoJSON(){
        if(listMarker.length != 0){
            geoJSON = L.geoJSON(turf.featureCollection(toGeoJSON(listMarker, "marker", "prop")), {
                onEachFeature: function(feature, layer) {
                    layer.on("click", function(e){
                        currentId = layer
                    })
                    layer.bindTooltip("<p>" + feature.properties.message + "</p>")
                },
                style: function(feature){
                    return feature.properties.style
                }
            }).addTo(mymap)
            mymap.fitBounds(geoJSON.getBounds());
            showHasilGeoJSON();
        }
    }
    function toGeoJSON(list, cordinate_name, prop_name){
        var listGeoJson = [];
        for(var x = 0; x < list.length; x++){
            listGeoJson.push(turf.polygon([list[x][cordinate_name]], listMarker[x][prop_name]));
        }
        return listGeoJson;
    }
    function addPolygon(x){
        var y = [];
        for(var z = 0; z < x[0].length; z++){
            y.push([x[0][z].lng, x[0][z].lat])
        }
        y.push(y[0]);
        listMarker.push({
            marker: y,
            prop: {
                    message: el("message").value,
                    style: {
                        fillColor: el("fillColor").value || defaultStyle.fillColor,
                        weight: el("weight").value || defaultStyle.weight,
                        opacity: 1,
                        color: el("color").value || defaultStyle.color,
                        dashArray: el("dashArray").value || defaultStyle.dashArray,
                        fillOpacity: el("fillOpacity").value || defaultStyle.fillOpacity
                    }
                }
            }
        );
        refreshMap();
    };
    function getPopUp(x){
        x = JSON.stringify(x)
        return "<div style='width:200px; height: 150px; overflow-x:hidden; overflow-y:scroll;  '><p><label>Warna Isian</label> <input class='w3-input w3-border' type='color' id='fillColor' /></p>" +
            "<p><label>Warna Pembatas</label> <input class='w3-input w3-border' type='color' id='color' /></p>" +
            "<p><label>Besar Strip Pembatas</label> <input class='w3-input w3-border' type='number' id='dashArray'  min='0' max='10' /></p>" +
            "<p><label>Ketebalan Pembatas</label> <input class='w3-input w3-border' type='number' id='weight' min='0' max='10' /></p>" +
            "<p><label>Besar Transparant</label> <input class='w3-input w3-border' type='number' id='fillOpacity' step='0.1' min='0' max='1' /></p>" +
            "<p><label>Isi Pesan</label> <textarea class='w3-input w3-border' id='message'></textarea></p>" +
            "<button type='button' class='w3-btn w3-teal' onclick='addPolygon("+x+");'>Terapkan</button>" +
            "<button type='button' class='w3-btn w3-red' onclick='currentLayerJSON.layer.remove(); refreshMap();'>Batal</button></div>";
    };
    function removeGeoJSON(){
        geoJSON.clearLayers();
    }
    function showTable(head, data){
        var thead = "", tbody = "";
        thead += "<thead><tr class='w3-teal'>";
        for(var x = 0; x < head.length; x++){
            thead += "<th>" + head[x].caption + "</th>";
        }
        thead += "</thead></tr>";
        tbody += "<tbody>";
        if(data.length != 0){
            for(var x = 0; x < data.length; x++){
                tbody += "<tr>";
                for(var y = 0; y < head.length; y++){
                    if(head[y].name[0] == "_"){
                        tbody += "<td>" + head[y].format(x) + "</td>";
                    }else{
                        if(head[y].format){
                            tbody += "<td>" + head[y].format(data[x][head[y].name]) + "</td>";
                        }else tbody += "<td>" + data[x][head[y].name] + "</td>";
                    }
                }
                tbody += "</tr>";
            }
        }else{
            tbody += "<tr><td class='w3-center' colspan='" + head.length+1 + "'><b>Data Kosong</b></td></tr>"
        }
        tbody += "</tbody>";
        return thead + tbody;
    }
    function deletePolygon(x){
        listMarker.splice(x,1);
        refreshMap();
    }
    function importGeoJSON(){
        if(el("hasilGeoJSON").value){
            geoJSON = L.geoJSON(JSON.parse(el("hasilGeoJSON").value), {
                onEachFeature: function(feature, layer) {
                    layer.on("click", function(e){
                        currentId = layer
                    })
                    layer.bindTooltip("<p>" + feature.properties.message + "</p>")
                },
                style: function(feature){
                    return feature.properties.style
                }
            }).addTo(mymap)
            mymap.fitBounds(geoJSON.getBounds());
            showHasilGeoJSON();
        } 
    }
    function gantiPeta(peta){
        mymap.remove();
        initMap(peta);
        refreshMap();
    }
    //EOF METHOD
    
    //START OF PROGRAM
    initMap();
    refreshMap();
    </script>
</body>

</html>
