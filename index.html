<!DOCTYPE html>
<html>

<head>

    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="w3.css" />
    <link rel="stylesheet" href="leaflet.css" />
    <script src="leaflet.js"></script>
    <script src="turf.min.js"></script>
    <link rel="stylesheet" href="leaflet.pm.css" />
    <script src="leaflet.pm.min.js"></script>
</head>
<body>
    <div class="w3-container">
        <p>Tambahkan poligon untuk melihat hasil</p>
        <div id="mapid" style="width: 500px; height: 500px;"></div>
        <hr/>
        <table id="listMarker" class="w3-table w3-bordered"></table>
        <label>Hasil GeoJSON</label>
        <textarea id="hasil" class="w3-input w3-border"></textarea>
        <button type="button" class="w3-btn w3-red" onclick="removeGeoJSON">Reset GeoJSON</button>
    </div>
    <script>
    var posisi = [-0.942942, 100.371857];
    var zoom = 13;
    var token = 'pk.eyJ1IjoiZWdvZGFzYSIsImEiOiJjamd4NWkyMmwwNms2MnhsamJvaWQ3NGZmIn0.6ok1IiPZ0sPNXmiIe-iEWA';
    var mymap = null;
    var options = {
        position: 'topleft', // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
        drawMarker: false, // adds button to draw markers
        drawPolyline: false, // adds button to draw a polyline
        drawRectangle: true, // adds button to draw a rectangle
        drawPolygon: true, // adds button to draw a polygon
        drawCircle: false, // adds button to draw a cricle
        cutPolygon: false, // adds button to cut a hole in a polygon
        editMode: false, // adds button to toggle edit mode for all layers
        removalMode: false, // adds a button to remove layers
    };
    var polygonStyle = {
            fillColor: '#800026',
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: '3',
            fillOpacity: 0.7
        };
    var listPolygon = [];
    var geoJSON = null;
    //Setiap layer baru, di masukkan ke variabel ini agar bisa dihapus jika batal membuat polygon
    var currentLayerJSON = null;
    var currentId = null;
    var tableHead = [
    {
        name: "prop",
        caption: "Isi Pesan",
        format: function(x){ 
            return x.pesan;
            }
    },
    {
        name: "prop",
        caption: "Warna Poligon",
        format: function(x){ 
            return "<div style='width: 100px; height: 25px; background-color: " + x.style.fillColor + "; border: 5px dashed " + x.style.color +";'></div>";
            }
    }];
    // EOF DATA
    
    //START OF METHOD
    function el(x){
        return document.getElementById(x);
    }
    function showHasil(x){
        el("hasil").value = JSON.stringify(x);
    }
    function initMap(){
        mymap = L.map('mapid').setView(posisi, zoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            id: 'mapid'
            }).addTo(mymap);
        mymap.pm.addControls(options);
        mymap.on('pm:create', function(e){
            //layer dimasukkan ke variabel agar bisa dihapus
            currentLayerJSON = e;
            
            //Menampilkan popup untuk layer baru
            e.layer.bindPopup(getPopUp(e.layer._latlngs), {className: "w3-panel"}).openPopup();
        });
    };
    function refreshMap(){
        if(currentLayerJSON) {
            currentLayerJSON.layer.remove();
        }
        if(geoJSON){
            geoJSON.clearLayers();
        }
        this.mymap.closePopup();
        showGeoJSON();
    }
    function showGeoJSON(){
        if(listPolygon.length != 0){
            geoJSON = L.geoJSON(turf.featureCollection(toGeoJSON(listPolygon, "marker", "prop")), {
                onEachFeature: function(feature, layer) {
                    layer.on("click", function(e){
                        currentId = layer
                    })
                    layer.bindTooltip("<p>" + feature.properties.pesan + "</p>")
                    layer.bindPopup("<p>" + feature.properties.pesan + "</p><button class='w3-btn w3-red' onclick='removeGeoJSONLayer()'>Hapus</button>");
                },
                style: function(feature){
                    return feature.properties.style
                }
            }).addTo(mymap)
            mymap.fitBounds(geoJSON.getBounds());
            showHasil(turf.featureCollection(toGeoJSON(listPolygon, "marker", "prop")));
        }
    }
    function toGeoJSON(list, cordinate_name, prop_name){
        var listGeoJson = [];
        for(var x = 0; x < list.length; x++){
            listGeoJson.push(turf.polygon([list[x][cordinate_name]], listPolygon[x][prop_name]));
        }
        return listGeoJson;
    }
    function addPolygon(x){
        var y = [];
        for(var z = 0; z < x[0].length; z++){
            y.push([x[0][z].lng, x[0][z].lat])
        }
        y.push(y[0]);
        listPolygon.push({
            marker: y,
            prop: {
                    pesan: el("pesan").value,
                    style: {
                        fillColor: el("fillColor").value || polygonStyle.fillColor,
                        weight: el("weight").value || polygonStyle.weight,
                        opacity: 1,
                        color: el("color").value || polygonStyle.color,
                        dashArray: el("dashArray").value || polygonStyle.dashArray,
                        fillOpacity: el("fillOpacity").value || polygonStyle.fillOpacity
                    }
                }
            }
        );
        refreshMap();
        el("listMarker").innerHTML = showTable(tableHead, listPolygon);
    };
    function getPopUp(x){
        x = JSON.stringify(x)
        return "<div style='width:200px; height: 150px; overflow-x:hidden; overflow-y:scroll;  '><p><label>Warna Isian</label> <input class='w3-input w3-border' type='color' id='fillColor' /></p>" +
            "<p><label>Warna Pembatas</label> <input class='w3-input w3-border' type='color' id='color' /></p>" +
            "<p><label>Besar Strip Pembatas</label> <input class='w3-input w3-border' type='number' id='dashArray'  min='0' max='10' /></p>" +
            "<p><label>Ketebalan Pembatas</label> <input class='w3-input w3-border' type='number' id='weight' min='0' max='10' /></p>" +
            "<p><label>Besar Transparant</label> <input class='w3-input w3-border' type='number' id='fillOpacity' step='0.1' min='0' max='1' /></p>" +
            "<p><label>Isi Pesan</label> <textarea class='w3-input w3-border' id='pesan'></textarea></p>" +
            "<button type='button' class='w3-btn w3-teal' onclick='addPolygon("+x+");'>Terapkan</button>" +
            "<button type='button' class='w3-btn w3-red' onclick='currentLayerJSON.layer.remove(); refreshMap();'>Batal</button></div>";
    };
    function removeGeoJSON(){
        console.log(geoJSON.getLayers())
        geoJSON.clearLayers();
    }
    function removeGeoJSONLayer(){
        geoJSON.removeLayer(currentId);
        currentId = null;
    }
    function showTable(head, data){
        var thead = "", tbody = "";
        thead += "<thead><tr class='w3-teal'>";
        for(var x = 0; x < head.length; x++){
            thead += "<th>" + head[x].caption + "</th>";
        }
        thead += "</thead></tr>";
        
        tbody += "<tbody>";
        for(var x = 0; x < data.length; x++){
            tbody += "<tr>";
            for(var y = 0; y < head.length; y++){
                if(head[y].format){
                    tbody += "<td>" + head[y].format(data[x][head[y].name]) + "</td>";
                }else tbody += "<td>" + data[x][head[y].name] + "</td>";
            }
            tbody += "</tr>";
        }
        tbody += "</tbody>";
        return thead + tbody;
    }
    //EOF METHOD
    
    //START OF PROGRAM
    initMap();
    refreshMap();
    </script>
</body>

</html>
